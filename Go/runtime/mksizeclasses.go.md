# File: mksizeclasses.go

mksizeclasses.go是Go语言运行时包中的一个源文件，其主要作用是生成并导出内存分配的size class。size class是指一组预定的内存大小，用于分配内存时快速计算所需内存大小和所需的内存块数量。

具体来说，该文件的主要作用是：

1. 根据 Go 语言运行时的可用内存大小，生成适合的 size class 列表。size class 列表是一组具有递增的内存大小和固定数量的 chunk 数组。chunk 数组是指可用于分配内存的一段连续内存块。

2. 导出 size class 列表，供其他模块（如 GC 和分配器）使用。在程序运行时，当需要分配内存时，会根据所需内存大小查找对应的 size class，分配一定数量的 chunk 块。若某个 size class 中的 chunk 块不足了，则会尝试使用更大的 size class。

通过使用 size class，可以快速分配内存而不必进行复杂的计算。这样就大大提高了 Go 语言程序的内存分配效率。




---

### Var:

### stdout

mksizeclasses.go文件是Go语言运行时包中的一个文件，它是用来生成（make）不同大小对象的大小分类列表（size classes）的文件。其中，stdout变量是用于存储标准输出信息的变量，它的作用主要有以下几点：

1. 记录生成大小分类列表的过程：
在mksizeclasses.go文件中调用fmt包的Println方法输出信息，而如果没有stdout变量，这些信息可能会输出到终端，这样就很难进行记录或者保存，而stdout变量则可以将这些输出信息收集起来，方便在需要的时候进行查看和分析。

2. 提供输出接口：
mksizeclasses.go文件还提供了一个ExportSizeClasses函数，它会将生成的大小分类列表输出到标准输出流中（stdout变量所代表的输出流），这样其他模块或者程序就可以利用stdout变量得到大小分类列表了。

3. 统计输出信息：
stdout变量也可以作为一个统计工具，可以通过统计stdout变量的大小或输出信息的行数等方式来衡量程序在生成大小分类列表时的耗时和输出质量。同时，由于stdout变量是并发安全的，因此也可以在多线程环境下使用，方便进行并发统计。

总之，stdout变量在mksizeclasses.go文件中的作用主要是记录和输出程序的生成过程，以及提供输出接口和统计工具。






---

### Structs:

### class

在go/src/runtime/mksizeclasses.go中，class这个结构体用来表示某个大小的内存块对应的大小分类。

具体来说，SizeClasses数组中的每一项都是一个class结构体，表示的是一组内存块大小，例如：

```go
class{size: 8, nlarge: 0, nsmall: 32, npages: 1}
```

这个结构体表示的是大小为8字节的内存块，共有32个连续的小块。这些小块在空闲列表中的组织方式是由Heap结构体中的MHeap结构体维护的。

通过class结构体，我们就可以将不同大小的内存块划分成一系列大小分类，方便进行内存管理和分配操作。在初始化堆空间时，会根据这些分类创建不同大小的内存块，以备后续使用。同时，这些分类也是GC的重要依据之一。

总之，class结构体在Go的内存管理和垃圾回收中扮演着重要的角色，是对不同大小内存块的分类、组织和管理的关键。



## Functions:

### main

在Go语言中，内存管理是非常重要的一部分。每个内存分配都会涉及到大小分类、内存对齐、缓存等问题。这些细节都需要通过计算来确定，而不能简单地使用固定的常数。

在runtime包中，mksizeclasses.go文件中的main函数定义了一些常量和变量，用于计算对象大小分类和对象所属的堆大小。这些信息对于后续内存分配和对象布局是非常重要的。

main函数做了如下事情：

1. 定义了一些常量和变量，如：指向第一个堆大小的指针，每个大小分类所能包含的最大对象大小，对象大小类别总数等。

2. 计算了每个对象大小所属的堆大小。Go运行时中的堆是由许多块内存组成的，每一块都包含一些相同大小的对象。计算堆大小的过程就是为了能够在内存分配时快速找到能够满足要求的堆块。

3. 计算了每个对象所属的大小分类。大小分类是根据对象大小来划分的，具有相同大小的对象会被划分为同一个分类，方便内存分配时快速定位所需的大小。计算这些分类的过程是根据内存对齐的规则进行的，确保每个对象所属的分类都具有最优的性能和空间利用率。

总之，mksizeclasses.go文件中的main函数定义了一些重要的常量和变量，用于确定内存分配的细节，从而提高内存分配和对象布局的性能和空间利用率。



### powerOfTwo

powerOfTwo函数的作用是计算2的正整数次幂（也就是2的指数）。

具体来说，它接受一个无符号整数n作为输入，然后找到最小的k，使得2^k >= n。换句话说，它返回一个大于等于n的最小的2的指数。这个值在计算内存大小分配的时候非常有用，因为这个算法把内存大小分配成一系列2的指数（例如16、32、64、128等），这样可以提高内存分配的效率。

在mksizeclasses.go中，powerOfTwo函数还计算了一个最大的指数值max, 用于表示最大的内存分配大小。具体来说，它通过一系列的左移操作，将一个无符号整数1不断左移，直到得到一个超过了系统架构允许的最大内存大小的值，然后将这个值右移一位，这样就得到了一个最大的2的指数值。这个指数值是根据当前计算机系统的架构（例如32位或64位）来确定的，可以保证能够正确处理所有可能的内存大小分配。



### makeClasses

makeClasses这个函数是用来生成不同大小的内存块的内存分配器的数据结构的。在 Go 中，每个内存分配器都有一组的 size classes，每个 size class 对应一组大小相等的内存块。mksizeclasses.go 中的 makeClasses 函数将 size classes 的数据结构生成并填充到指定的数组中。

makeClasses 函数首先根据指定的最小块大小和最大块大小计算出需要分配的内存 block 的数量，然后使用这个数量计算出 k 的大小，k 是每个 size class 中内存块的大小的对数值，也就是每个 block 的大小可以用 $2^k$ 来表示。

然后，makeClasses 函数开始填充 size classes 数组，每个 size class 中都包含一个与 k 相关的变量，包括:

1. size - 表示该 size class 中内存块的大小。
2. npages - 表示需要分配的内存块的页数。
3. nobjs - 表示该 size class 中的 block 数量。
4. log2\_nalign - 表示该 size class 内存块对齐所需的 log2(n) 值。
5. span\_class - 表示与该 size class 中内存块大小相对应的 span 的类别。

size classes 中的 size、npages 和 nobjs 值按照一定的算法计算得到，而 log2\_nalign 根据系统的内存对齐要求进行计算，span\_class 则是通过系统的内存映射信息来计算得到。

最后，makeClasses 函数返回填充好的 size classes 数组作为结果，这个数组可以在内存分配器中使用来快速分配不同大小的内存块。



### computeDivMagic

computeDivMagic是一个函数，用于计算一些常量值，以便在运行时动态计算对象的大小。在分配内存时，计算出大小类，然后使用该大小类从相应的容量类中分配内存块。每个容量类都由多个大小类组成，每个大小类都代表一组具有相同大小和分配器元数据的对象。因此，computeDivMagic的作用是作为计算这些大小类的参考的一部分。

具体而言，该函数计算了“magic”值，该值是将一个值除以某个常量的近似值。在运行时，使用此近似值来计算二进制移位来代替除法操作，以提高性能。computeDivMagic函数计算并返回一个32位无符号整数，该整数与所需的除数一起用于计算近似值。

computeDivMagic函数的算法基于贪心算法，为了计算所需的近似值，它尝试找到比除数更接近2^32的最小2的幂，因为可以使用32位无符号整数来表示此幂的值，并且可以通过左移操作来计算它的逆操作，而不是使用除法操作。

最后，computeDivMagic函数返回一个结构体，其中包括两个成员：magic和shift，分别代表计算出的乘数和必要的位移。这些值可以用于简单的算术运算，以便在运行时有效地将除法操作替换为位移操作。



### printComment

在go/src/runtime中mksizeclasses.go文件中的printComment func的作用是在生成class的代码时打印出对应class的说明注释。这些说明注释包含了该class的起始大小，结束大小和每个字节的大小。

这些注释对于开发人员了解类的大小范围非常有用，有助于提高代码的可读性和维护性。此外，这些注释还可以帮助开发人员调整类的大小范围以优化程序性能。

在具体实现过程中，这个func会根据不同class的大小生成相应的注释，然后输出到标准输出中。这些注释包含有关class大小的所有信息，包括首字节大小，最后一个字节大小和每个字节的大小。这些信息可以帮助开发人员更好地理解类的大小范围，以便更好地优化程序。



### printClasses

在Go语言中，对象的分配与管理是通过大小类来进行的。mksizeclasses.go文件中的printClasses函数就是用来打印不同大小类的信息的。

具体来说，printClasses会将不同的对象大小与相应的大小类打印出来。大小类是指以2为底的指数级增长的对象大小的集合，例如，sizeclass 0代表8字节，sizeclass 1代表16字节，sizeclass 2代表32字节，以此类推。在printClasses中，会根据一定的规则，将不同的对象大小映射成对应的大小类，并将它们打印出来。

这个函数的作用在于，让开发者了解在不同的对象大小下，Go语言是如何管理内存的。通过打印不同大小类的信息，开发者可以更好地了解Go语言内存管理的特点和机制。同时，对于高性能程序员来说，理解这些大小类也可以有助于优化内存分配和管理的效率。



