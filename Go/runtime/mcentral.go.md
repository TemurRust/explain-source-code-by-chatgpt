# File: mcentral.go

mcentral.go是Go语言运行时的一个重要文件，其作用是管理内存分配的中心池。在Go语言中，内存分配是由运行时系统负责的，mcentral.go文件定义了中心池的数据结构和相关的操作方法。

中心池是一种可以高效地管理小对象分配的内存池，其中分配的内存被平均分配给各个线程，并且使用缓存机制来避免频繁的系统调用。mcentral.go定义了中心池的数据结构，包括：

- mcentral：中心池，它包含了一组mspan。每个mspan分别用于存储不同大小（从8字节到32768字节不等）的对象。mcentral的数量可以通过环境变量GOMAXPROCS来控制。

- mspan：mspan是对一块内存的抽象，它包含了一定数量的固定大小的内存块。每个mspan都具有固定的大小，其大小范围从8字节到32768字节不等。

- mcache：mcache是每个线程的缓存，它存储不同大小的对象以提高分配效率。每个线程都有一个mcache，其中包含mspan指针列表，这些指针指向某个中心池中的mspan。

中心池的主要操作包括：

- 分配：从中心池中分配一块内存。如果mcache中有可用的对象，则从mcache中获取一个，否则从中心池中获取一个。

- 释放：将对象返回给中心池。如果mcache已满，则将对象退回到中心池中。

- 扩展：在需要更多内存时，从操作系统中请求更多内存并将其添加到中心池中。

总的来说，mcentral.go文件的作用是实现内存池管理，以提高内存分配的效率和性能。它是Go语言运行时系统的核心组件之一，负责管理并提供内存分配服务。




---

### Structs:

### mcentral

mcentral结构体是Go语言运行时中心缓存的管理器，用于管理各个尺寸(大小)的span。每一个mcentral结构体都代表一个尺寸，其中存储着一组包含相同大小的span。mcentral包含一个大小为_2P的span列表，span列表是一个固定大小的集合，每个元素都代表了一组相同大小的span。每当需要新的span时，mcentral就会从span列表中取出一个来使用，如果没有可用的span，就会向mcache申请新的span。

mcentral结构体有以下几个重要字段：

- spanclass: span在全局可供使用的大小分类中的索引。
- nonempty：包含span的数量。
- span：一个_2P大小的数组，存放着size对应的span。
- nagetive_spans：表示从其他地方借用的span数组。

mcentral结构体的主要作用是将内存按照尺寸分类管理，使得运行时能够根据需要高效地使用内存，提高程序运行性能。mcentral是Go语言运行时的重要组成部分，对于理解Go语言内存管理方式非常重要。



## Functions:

### init

在go/src/runtime/mcentral.go文件中，init函数的作用是为centralCache初始化并初始化了一组span列表，这些span列表在后续的对象分配过程中被用来分配内存块。

具体而言，init函数首先为heapArena指定了span大小。然后，它的主要任务是为每个尺寸（ sizeclass ）初始化一个对应的span列表（ spanList ）。这些span列表存储与该尺寸匹配的空闲的spans，并在需要向应用程序分配对象时使用。

init函数为每个spanList生成了一个nil指针作为其头部。接着，它会检查该尺寸的对象是否适合于任何一组已知大小，并将相应的spanList指向该组。最后，它会分配一些可以用于分配对象的span，并将它们添加到所有的spanList中。

总之，init函数在基于mcentral.go模块中创建中央缓存时扮演着非常重要的角色，第一次调用时会初始化一些列表，使分配器能够快速将内存块分配给尺寸相同的对象。



### partialUnswept

func partialUnswept(span *mspan) uintptr

partialUnswept函数用于标记一个尚未全部清扫完毕的span。在Go语言中，内存分配采用的是分代垃圾回收算法，内存块被分为若干个span，由mcentral对象统一管理。partialUnswept函数被调用时，表示span未被完全清扫。该函数将span的状态设置为“部分未清扫”，并返回span未清扫的数量。

在垃圾回收的过程中，为了保证有足够的内存可供分配，必须确保已经被释放的内存被回收，并把这些内存归还给操作系统。partialUnswept函数起到标记未清扫的span的作用，当垃圾回收器扫描到这些span时，会根据垃圾回收策略相应地进行垃圾回收和内存释放。

此外，partialUnswept函数也会在分配新的内存块时进行调用。当需要分配内存时，runtime会首先查找已经被回收的内存块，如果没有可用的内存块，则会分配新的内存块。在分配新的内存块时，如果已经存在部分未清扫的span，那么会重新将这些未清扫的span作为第一优先级进行扫描和回收，以尽快地释放内存。

因此，partialUnswept函数是Go语言垃圾回收算法中重要的一环，它能够帮助垃圾回收器更快地回收内存，从而提高程序的性能和稳定性。



### partialSwept

在Go语言的垃圾回收器中，mcentral.go文件中的partialSwept函数主要用于对垃圾回收的分配器中间数据结构（mcentral）中的无主对象（未被标记的对象）进行回收。

在Go语言中，垃圾回收器将存储分配器中的分配对象进行标记和标记清除操作。当垃圾回收器执行标记阶段时，它会标记所有的存活对象。但是，有些存活对象在扫描过程中不需要扫描整个对象，只需要扫描部分对象就可以了。这些被标记为部分扫描的对象可以被垃圾回收器识别为partial object，并放在mcentral数据结构的partialUnswept链表中。partialSwept函数就是用来回收这个链表中的对象的。

partialSwept函数的作用是将partialUnswept链表中的对象重新标记，并将未标记的对象添加到mheap结构体中的free列表中。这样，未被标记的对象就可以被垃圾回收器回收了。

总之，partialSwept函数的主要作用是将分配器中的未被标记的对象重新标记，并回收它们。这个函数是垃圾回收器中非常重要的一部分，能够提高垃圾回收的效率和性能。



### fullUnswept

在Go语言的垃圾回收器中，每个mcentral代表着一类大小相同的对象。当一个对象被分配时，它首先尝试从相应的mcentral获取一个可用的对象。如果mcentral中没有可用的对象，则会从全局列表中获取未清扫的对象并进行清扫。如果从全局列表中找到的未清扫对象数量超过了一定阈值，就会调用`fullUnswept`函数。

`fullUnswept`函数的作用是全局扫描未清扫的对象并将其分配给对应大小的mcentral，以便后续使用。在函数`fullUnswept`中，会遍历全局的未清扫对象列表，将大小相同的对象放入相应的mcentral对应的span中，并将其他不可用的对象交给垃圾回收器进行清理。

此外，`fullUnswept`函数还会更新全局的未清扫对象数量，并判断是否需要触发GC标记流程以回收更多不可用的对象。这些操作都是为了提高垃圾回收的效率和内存利用率。



### fullSwept

fullSwept函数的作用是将中心缓存mcentral中的已扫描的对象全部释放，以便重新使用。

在Go语言的垃圾回收机制中，若gc时间比较长或者gc触发频率比较高时，会使用几个goroutine来进行并行的扫描和回收工作，每个goroutine负责扫描一部分堆对象并标记，最后再统一回收。在这个过程中，扫描过程会产生新的对象，这些新的对象会被放入中心缓存mcentral中，以等待下一次gc完成后进行处理。

当中心缓存mcentral中的对象满了时，就需要将已扫描的对象全部释放，以便重新使用。fullSwept函数就是在这个时候被调用，它会遍历中心缓存mcentral中的已扫描对象列表，将其全部释放，以供下一次gc使用。这个过程中，释放对象并不会影响整个堆的内存使用情况，因为这些对象都已经被扫描并标记为无用对象，需要重新分配内存时，垃圾回收器会直接从空的空闲列表中分配空间而不是从中心缓存中获取。



### cacheSpan

cacheSpan函数是Golang运行时系统中mcentral.go文件中的一个函数，主要用于从中央堆中为特定的span缓存一些对象。

在Golang中，当需要分配内存时，会优先从mcache（本地缓存）中获取，然后再从mcentral（中央堆）中获取，最后从mspan（受保护的堆）中获取。cacheSpan函数就是在mcentral中缓存span以从中央堆中获取内存。

具体来说，cacheSpan函数中使用了一个cache数组作为缓存机制，将空闲的span对象存储到cache数组中。当需要从中央堆中获取span时，先从缓存中查找，如果没有则从中央堆中取出一个新的span，然后将其存储到cache数组中，在下一次需要时可以直接使用缓存中的span对象，避免了频繁的中央堆操作，提高了效率。

需要注意的是，cache数组的容量是有限的，当缓存已满时，新的span对象无法存储到缓存中，此时会退化为从中央堆中获取新的span对象。

总之，cacheSpan函数的作用是提高内存分配的效率，减少中央堆的访问次数，从而提高程序的性能。



### uncacheSpan

uncacheSpan函数位于M Central堆管理器的mcentral.go文件中，它的作用是撤销对span的缓存。 当堆分配器需要分配内存时，它首先搜索缓存的span以查找可用的空闲块。如果在缓存的span中未找到任何可用块，则堆分配器必须从操作系统中分配更多的内存，导致额外的开销和延迟。

uncacheSpan函数会撤销对span的缓存，以便堆分配器在以后的分配中不再使用它。一般情况下，uncacheSpan函数是在span已满或已释放后调用的。

在执行uncacheSpan函数时，它将span从其mcache中的相应链表中移除，并将其插入堆管理器的相应span链表中。这样就可以避免在堆分配器尝试寻找可用内存时搜索这个已满或已释放的span，从而提高程序的性能。



### grow

mcentral.go中的grow函数是用来增加mcentral的span列表的容量。每个mcentral都有一个span列表，用于存储span，当span不足时就需要增加容量。

grow函数的实现是通过申请新的span数组来实现的，首先计算需要新增的span数量，然后将原有的span列表复制到新的数组中，最后将新增的空间添加到新的数组末尾。最后将新的数组替换原有的数组，并更新相应的元信息，如span数量和容量等。

这个函数的主要作用就是为了保证mcentral的span列表能够容纳足够的span，确保分配器的正常运行。



