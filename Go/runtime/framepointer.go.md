# File: framepointer.go

framepointer.go是Go语言运行时（runtime）的一个文件，主要实现了获取Goroutine的帧指针（frame pointer）的功能。

Goroutine的帧指针是一个指针，指向当前正在运行的函数的栈帧顶部。在函数调用时，程序将当前函数的返回地址和参数等信息存储在栈帧中。帧指针指向栈帧的顶部，可以用来访问这些信息。

获取Goroutine的帧指针对于调试和性能分析等任务非常重要。如果没有一个有效的方法来获取帧指针，这些任务将变得非常困难。

framepointer.go中的函数getcallerpc和getcallersp可以分别获取当前函数的调用者指令地址（caller PC）和调用者栈指针（caller SP）。这些函数使用汇编代码实现，利用了x86和AMD64架构中的指令来访问堆栈中的数据。

实际上，获取Goroutine的帧指针并不是一件简单的事情，因为Go语言的调度器会频繁地切换Goroutine，每次切换都会导致堆栈的重建和地址的变化。framepointer.go通过一系列技巧来处理这些复杂的情况，确保能够正确地获取帧指针。

总之，framepointer.go是Go语言运行时中非常重要的一个文件，它提供了获取Goroutine帧指针的功能，为调试和性能分析等任务提供了重要的支持。

## Functions:

### init

在Go语言中，当我们使用GDB调试时，由于编译器默认会关闭帧指针(frame pointer)，这会影响到程序的调试。因此，Go语言运行时提供了一个名为framepointer的包，来帮助我们在GDB调试程序时跟踪函数调用栈。

init函数是在包初始化时自动调用的函数，用来初始化包内部的变量和依赖关系。framepointer包中的init函数的作用是在程序启动时检查当前机器的CPU架构，以确定是否启用帧指针。如果机器支持使用帧指针，那么启用帧指针后，我们调试程序时就可以通过帧指针来获取调用栈信息了。

具体来说，framepointer包中的init函数会根据不同的CPU架构来设置使用帧指针的标志位，然后会更新runtime包中的globalpclntab指针，该指针指向一个用于反射程序信息的全局符号表。最后，init函数会调用tracebackinit函数来初始化跟踪回溯的相关参数，包括堆栈大小、堆栈缓存等。

总之，framepointer包中的init函数的作用是在程序启动时检查机器支持的CPU架构，设置帧指针的标志位并初始化跟踪回溯的相关参数，使得我们在GDB调试程序时能够准确地获取函数调用栈信息。



### FramePointerAdjust

函数FramePointerAdjust的作用是根据CPU架构来确定调整函数堆栈指针的值。堆栈指针用于跟踪函数执行期间活动数据的存储位置。在某些情况下，堆栈指针还可用于跟踪函数调用之间的执令流，以及跟踪函数的嵌套层次等。

FramePointerAdjust函数是用于x86平台的，在这个平台上，它的目的是调整ESP(Stack Pointer)寄存器的值，以便让EBP(Frame Pointer)寄存器指向正确的位置。这是因为在x86平台上，EBP寄存器通常被用来指向堆栈中上一个函数的栈帧。FramePointerAdjust函数可以在调用函数之前调整堆栈指针的值，以便在调用函数时，EBP指针可以指向新的函数堆栈帧。在某些情况下，这个调整可能是必要的，以便在调用函数时可以正确定位上一级函数的栈帧。

在一些代码中，FramePointerAdjust还被用来修正堆栈中每个栈帧的大小，以确保堆栈帧始终有正确的大小。这种修正可以通过抵消上一级函数留下的堆栈指针调整来实现。默认情况下，堆栈帧的大小由编译器自动计算，但是在有些情况下，手动调整是必须的，例如在编写嵌入式系统代码时，需要手动管理堆栈帧大小来确保代码的正确性。



### framePointerAdjust1

framePointerAdjust1 函数用于调整帧指针。在x86平台上，栈帧使用EBP寄存器来引用它们的局部变量和参数。但是，在Go 1.14之前，Go会将EBP信息丢弃，以帮助调试器符号化堆栈跟踪。但是，丢弃EBP会使堆栈场景难以解析，尤其是嵌套调用时。因此，从Go 1.15开始，Go重新引入了EBP，以帮助调试器重新构建堆栈跟踪。framePointerAdjust1函数用于调整EBP寄存器的值，使其指向上一个栈帧的EBP值。

该函数的参数是传递给函数的指针，以指向它的调用者。然后，该函数将EBP设置为该指针减去传递给该函数的框架大小。在这种情况下，帧指针被指定为当前框架指针减去帧的大小。然后，该函数返回下一个框架的指针，以便可以继续对其进行相同的操作。

adjustframeptr在调试模式下使用，它更改帧指针来指向参数指针的旧值 - 帧指针现在指向本地变量的开头，而不是EIP的旧值。这样，调试器可以将之与源代码中的行和文件匹配，并允许调试出Go程序的问题。



### grow

在Go的运行时中，framepointer.go文件中的grow函数用于动态增加堆栈的大小。当调用函数时，它会在堆栈上创建一个新的帧。随着程序的执行，帧的数量可能会增加。当堆栈上的帧数超过预定义的限制时，即堆栈溢出时，程序将会崩溃。

为了避免这种情况的发生，grow函数会在堆栈上增加一些额外的空间以允许更多的帧被创建。它会检查堆栈是否已达到最大大小，如果已经达到，则会通过调用异常处理器通知运行时，否则它会增加堆栈的大小，然后返回此堆栈的下一个栈顶指针。

在增加堆栈时，grow函数会调用runtime.morestack函数来分配更多的堆内存。在这个函数中，它会使用操作系统提供的虚拟内存机制来增加程序可用的堆空间。这个过程是动态的，因此可以根据程序的需要调整堆的大小。

总之，grow函数的主要作用是为程序增加堆栈空间，以允许更多的帧被创建，以避免堆栈溢出和程序崩溃。



### getFP





