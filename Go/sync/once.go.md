# File: once.go

sync 包中的once.go 文件包含了 Once 结构体和其中的方法，用于实现只运行一次的并发操作。Once 结构体主要包含一个用于保护执行状态的 Mutex 和一个 bool 值，表示操作是否已经完成。

Once 结构体的主要方法是 Do，该方法接收一个函数作为参数，该函数会在第一次调用 Do 方法时被执行。之后的调用都会被忽略，直到下一次程序运行时 Do 方法又可以被执行一次。

使用 Do 方法可以解决在多个 goroutine 中执行相同操作的竞态条件问题。在使用 once 时，可以确保操作只被执行一次，并且不需要手动使用互斥锁或其他的同步机制来保护。这提供了一种非常方便、简洁的实现方式，可以避免出现一些隐藏的竞态条件和死锁问题。

总之，sync 包中的 once.go 文件的作用是提供一种并发安全的、只执行一次的方法，帮助开发者解决多个 goroutine 中相同操作的竞态条件问题。




---

### Structs:

### Once

Once结构体用来保证某个函数只会被执行一次。其定义如下：

```go
type Once struct {
    m    Mutex
    done uint32
}
```

其中，m是一个互斥锁，done是一个标记，用来表示函数是否已经执行过。

Once结构体有一个重要的方法Do，其定义如下：

```go
func (o *Once) Do(f func()) {
    if atomic.LoadUint32(&o.done) == 1 {
        return
    }
    // Slow-path.
    o.m.Lock()
    defer o.m.Unlock()
    if o.done == 0 {
        defer atomic.StoreUint32(&o.done, 1)
        f()
    }
}
```

方法Do接收一个函数f作为参数。Do方法首先通过原子操作判断done标记是否已经被设置为1，表示函数已经被执行过。如果done为1，则直接返回。否则，Do方法获取锁，再次检查done标记，以确保在获取锁前，done标记没有被其他线程设置为1。如果done为0，则执行函数f并设置done标记为1，表示函数已经被执行过。

Once结构体的作用在并发编程中非常重要。它可以保证某个函数只会被执行一次，避免重复初始化或其他可能导致问题的操作。使用Once结构体可以简化代码，并提高程序的性能和可靠性。



## Functions:

### Do

Do函数是sync包中的一个函数，是一个用于确保仅执行一次操作的同步原语。具体来说，其作用是在并发调用中只执行一次函数。

Do函数有一个参数，需要传入一个需要执行的函数。其特点是在第一次被调用时会执行该函数，而其他并发调用不会。其中的实现是通过一个互斥锁和一个布尔值来实现的。在调用该函数时，首先会获取互斥锁，然后判断布尔值是否为false，如果是，则执行传递的函数，然后将布尔值置为true。最后，释放锁。如果布尔值为true，则直接返回，避免重复执行。

这个函数非常适用于那些只需要执行一次的操作，例如读取配置文件，初始化全局变量等等。它可确保每个goroutine都只会执行一次，避免资源浪费和重复执行。



### doSlow

doSlow函数是Once结构体中唯一的私有方法，它实际上执行了Once的初始化函数。但是由于这个初始化函数可能会非常慢，所以Once在执行初始化函数时会首先调用doSlow函数。

doSlow函数首先通过对比Once结构体中的done字段是否已经被置为1，来确定初始化函数是否已经被调用过。如果done字段为1，则表示已经调用过初始化函数，直接返回。如果done字段为0，则将done字段设置为2，表示当前在执行初始化函数。

接下来，doSlow函数调用了初始化函数并将其结果保存到once.do字段中。初始化函数仅会被调用一次，因为在调用之前Once已经将done字段设为2，所以没有其他线程能够绕过doSlow函数再次调用该初始化函数。最后，doSlow函数将done字段设为1，表示初始化函数已经被成功调用。

总之，doSlow函数的作用是保证在多线程情况下只调用一次初始化函数，并且对于一个已经被初始化的Once实例，该函数在多线程调用时应该是线程安全的。



