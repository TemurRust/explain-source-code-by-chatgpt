# File: addrselect.go

addrselect.go是一个Go语言标准库中net包中的一个文件，它主要用于在多个网络地址中进行选择的策略。在网络通信中，两个计算机间的连接需要建立网络套接字地址。在多个备选地址中，选择一个最佳的地址是提高网络通信效率和可靠性的关键问题之一。

该文件中定义了一个名为addrSelectionResult的结构体类型和一个名为addrSelectionSorter的排序器类型。其中addrSelectionResult结构体表示地址选择的结果，包括所选择的地址和它所属的网卡；addrSelectionSorter则用于排序和比较多个备选地址中的最佳地址。

addrselect.go中的核心函数是func selectAddr，它使用一系列算法来选择最佳的网络地址。具体来说，selectAddr函数的实现方式是针对不同的操作系统和网络环境而进行调整和优化的，目的是要选择出最适合当前网络环境的地址。其核心算法包括：按网卡权重、按访问时间、按带宽、按距离等。

在Go语言的标准库中，该文件的使用场景比较广泛，特别是在网络编程的过程中。例如，在Go的http包中使用addrselect.go文件来选择合适的IP地址和端口号，以提高http服务的稳定性和性能。它还广泛应用于Go的rpc包、dns包、smtp包等网络编程模块中。




---

### Var:

### rfc6724policyTable

在 Go 语言中，`net` 包中的 `addrselect.go` 文件提供了一个函数 `PreferIP`，用于从一组 IP 地址中选择最佳的地址。

在这个函数中，有一个 `rfc6724policyTable` 变量，它是一个 `policyTable` 结构体数组，用于按照 RFC 6724 中的规则来排序 IP 地址。

`rfc6724policyTable` 是一个全局变量，其作用是在 `PreferIP` 函数中提供一个默认的排序规则。该变量是一个结构体数组，其中每个结构体代表一个排序规则。

每个结构体包含以下字段：

- `family`: IP 地址族，IPv4 或 IPv6。
- `a`: 优先级。
- `b`: 代价因子。
- `c`: 标志位。

排序规则根据这些字段进行排序，并且按照字段从前到后的顺序依次比较。如果两个值相等，就比较下一个字段。

`rfc6724policyTable` 的作用就是提供一个默认的排序规则，用于 `PreferIP` 函数中选择最佳的地址。当用户没有指定排序规则时，系统就会使用这个默认的排序规则。

总之，`rfc6724policyTable` 是 `PreferIP` 函数中用于选择最佳 IP 地址的默认排序规则。






---

### Structs:

### ipAttr

在net包的addrselect.go文件中，ipAttr结构体用于表示一个IP地址的权重。一个IP地址的权重表示该地址是否更适合于作为通信的目标地址。在实际应用中，在选择网络地址时，网络通信程序需要考虑多种因素，如延迟、丢包率、可靠性等，而ipAttr结构体是用来权衡这些因素的。

ipAttr结构体的定义如下：

type ipAttr struct {
    preferSrc   bool    // 是否首选源地址
    addr        tcpip.Address   // IP地址
    score       float64 // 该IP地址的得分
    srcPort     uint16  // 源端口
    minRTT      time.Duration   // 最小RTT
    rttVar      time.Duration   // RTT的方差
    rcvWnd      int     // 接收缓冲区
    rxBufSize   int     // 接收缓冲区大小
    rxBufUsed   int     // 接收缓冲区使用情况
    sendBufSize int     // 发送缓冲区大小
    timestamp   int     // 时间戳
}

ipAttr结构体的字段含义如下：
- preferSrc：是否首选源地址
- addr：IP地址
- score：该IP地址的得分
- srcPort：源端口
- minRTT：最小RTT
- rttVar：RTT的方差
- rcvWnd：接收缓冲区
- rxBufSize：接收缓冲区大小
- rxBufUsed：接收缓冲区使用情况
- sendBufSize：发送缓冲区大小
- timestamp：时间戳

通过这些字段，ipAttr结构体可以表示一个IP地址的多个属性，并且在通过多种算法计算出该IP地址的权重后，根据权重来进行网络地址选择。



### byRFC6724

byRFC6724结构体是用于实现RFC 6724规范的地址选择算法的结构体。该规范旨在为网络连接选择提供更加智能化的算法，以便在多个可用的网络接口和地址之间进行选择。 

该结构体定义了一组参数和权重，用于比较和选择不同的地址。它包括以下内容：

1. sourcePreference：用于确定从哪个地址选择的优先级。例如，在IPv6中，源地址选项可能包括局域网地址、全球路由地址、私有地址等。

2. scopePreference：用于确定定位与远程主机之间的距离的权重或优先级。例如，在IPv6中，范围选项可能包括同一子网、自治系统、全球路由等。

3. prefixlen：用于确定地址前缀长度的权重或优先级。通常，较长的前缀（即更特定的地址）会具有更高的权重。

4. label：该字段用于使用通配符和相等性约束的路由选项。

5. family：用于确定地址族（IPv4或IPv6），并可能影响地址选择的其他参数。

使用该结构体，可以比较不同的地址，选择最优的地址及其对应的网络接口。这提高了网络连接的效率和速度，并使网络更加可靠和稳定。



### policyTableEntry

在Go语言标准库的net包中，addrselect.go文件定义了IP地址选择策略的函数，可以根据不同的条件和优先级从一组网络地址中选择合适的地址进行连接。其中，policyTableEntry结构体是IP地址选择策略表中的一个条目，用于存储一个IP地址和其相关的一些信息，以便后续的地址选择操作。

policyTableEntry结构体的定义如下：

type policyTableEntry struct {
    n     int     // 可用地址数量
    base  int     // 第一个可用地址的索引
    prio  uint8   // 地址优先级
    ts    uint32  // 最后一次使用的时间戳
    addr  []byte  // 地址字节序列
}

具体各字段的作用如下：

- n：这个地址条目中可用的地址数量
- base：第一个可用地址在整个地址列表中的索引位置
- prio：地址的优先级，数值越小表示优先级越高
- ts：最后一次使用这个地址的时间戳（用于地址缓存机制）
- addr：IP地址的字节序列

在IP地址选择策略中，会将所有可用的IP地址先按照优先级排序，然后按照一定的规则选择一个可用的地址进行连接。在实际使用中，可能还需要考虑其他因素，如地址的类型（IPv4或IPv6）、地址是否可达等因素，这些都会影响到选择一个合适的地址进行连接的效果和速度。



### policyTable

在Go语言的net包中，addrselect.go文件中的policyTable结构体是一个策略表，作用是帮助选择网络地址。

这个策略表包含了三个字段：一个返回结果和一个错误信息的函数，优先级，和一个唯一的名称。每个策略都是一个函数，它输入一组网络地址，输出一个网络地址（或错误信息），并确定是否应该继续搜索。

当选择网络地址时，先按照优先级从高到低依次尝试每个策略，只要有一个策略返回了可用的网络地址，就停止搜索。如果所有策略都返回错误，则网络地址选择失败。

策略表是一个可扩展的列表，可以使用net包的函数AppendNetworkAddressSelectionPolicy来添加新的策略，以便支持自定义网络地址选择逻辑。



### scope

在net包中，addrselect.go文件中的scope结构体是用于表示IP地址的作用域的。在IPv6网络中，每个IP地址都有一个作用域，它指定了IP地址的使用范围。作用域的值可以是全局范围、本地范围或链路本地范围等。

scope结构体中有三个字段：Value、Name和Desc。

Value字段用于表示IP地址的作用域，它的值是一个整数，取值范围是0到255。

Name字段是一个字符串类型的字段，用于表示作用域的名称。

Desc字段也是一个字符串类型的字段，用于表示作用域的描述信息。

在addrselect.go文件中，scope结构体被用于为IP地址选择算法中的IP地址打分。当算法需要选择一个IP地址时，会根据IP地址的作用域给它打分。具有更高作用域值的IP地址会得到更高的分数，从而更可能被选择。

总之，scope结构体用于表示IPv6地址的作用域，这对于IPv6地址的选择和路由非常重要。它为IPv6网络中的IP地址选择和路由提供了一个基础框架。



## Functions:

### sortByRFC6724

sortByRFC6724这个函数是在Go语言标准库的net包中的addrselect.go文件中实现的，它的作用是根据RFC 6724标准对地址进行排序，以便选择最佳的可用地址。

RFC 6724定义了一组规则，用于在IPv6和IPv4地址之间选择最佳的本地和远程地址。这些规则包括：

1.选择最长前缀匹配的地址；
2.优先选择同一接口ID的地址；
3.优先选择默认路由的地址；
4.在地址排序时，优先考虑源地址是否在目标地址的同一子网中，以减少数据包的路由次数；
5.在排序过程中，考虑地址的Precedence、Scope等因素。

sortByRFC6724函数就是根据上述规则来对一组IP地址进行排序的函数。具体实现过程如下：

1.首先将IP地址分成IPv4和IPv6两组进行排序
2.对于每组地址，按照RFC 6724中的规则进行排序
3.将排序结果按照RFC 6724中规定的顺序进行合并，得到最终的地址列表

最终，sortByRFC6724函数会返回一个按照RFC 6724规则排序后的地址列表。这个列表中，排在前面的地址是按照RFC 6724规则选择的最佳地址，排在后面的地址则按照优先级逐渐降低。程序可以根据这个列表从中选择最佳的地址。



### sortByRFC6724withSrcs

sortByRFC6724withSrcs这个函数的作用是根据RFC 6724标准对给定的地址列表进行排序，以便选择最佳的地址和源地址。此函数主要用于网络通信的源地址选择。 

RFC 6724是一项标准，规定了如何选择源地址和目标地址，以实现最佳的网络性能和连接质量。这个标准定义了一组规则，用于评估和排序可用的地址，以选择最佳的地址。

这个sortByRFC6724withSrcs函数会遍历所有的网络地址，并计算每个地址的优先级。然后，它将地址列表根据优先级排序，以使优先级最高的地址放在最前面。在计算优先级时，该函数根据RFC 6724标准考虑了多个因素，如地址类型、前缀长度、默认路由是否存在、地址是否是本地地址、地址是否与源地址匹配等等。

此函数还支持源地址选择，它会考虑来自各个源地址的数据包。因此，在排序地址列表时，它还要考虑每个地址对每个源地址的优先级。最后，这个函数会返回已排序的地址列表和相应的源地址。 

总的来说，sortByRFC6724withSrcs是一个非常重要的函数，它帮助程序选择最佳的网络地址和源地址，提高网络的性能和可靠性。



### srcAddrs

在go/src/net中addrselect.go这个文件中，srcAddrs函数的作用是从一个网络地址列表中选择源地址列表，使其更适合用于向给定目标地址发送数据包。

当我们要发送数据包到目标地址时，我们需要选择一个适合的源地址来发送数据包。这个源地址需要与目标地址在同一个子网中，并且与目标地址之间没有防火墙等设备阻止通信。

srcAddrs函数就是用来选择符合条件的源地址。它会从一个网络地址列表中，按照一定的规则选择子网中的地址作为源地址。当选中一个源地址后，其他不在同一子网中的地址会被过滤掉。

在Go语言中，srcAddrs函数的实现很简单，它只是遍历了所有网络地址并选择其中合适的作为源地址。如果没有找到满足要求的源地址，那么就返回一个空的地址列表。

总的来说，srcAddrs函数是用来帮助程序选择适合用于发送数据包的源地址。它的作用是优化网络连接，提高数据传输的成功率。



### ipAttrOf

ipAttrOf是一个私有函数，其作用是将一个IP地址转换成一个整数代表的属性值。在addrselect.go的代码中，ipAttrOf函数被用于比较两个IP地址的属性值大小，以确定选择哪个IP地址作为目标地址。更具体地说，ipAttrOf函数将一个IP地址拆分成四个8位的整数，并将它们合并成一个32位的整数。这个32位的整数可以被看作是IP地址的属性值，用于比较IP地址的大小。在AddrByPreference函数中，ipAttrOf函数被调用，以确定两个IP地址的选择顺序。通过比较IP地址的属性值，可以选择更靠近本地网络的IP地址作为目标地址，从而提高网络连接的性能和可靠性。总之，ipAttrOf函数是一个关键的功能函数，用于确定IP地址的属性值和选择顺序，从而提高网络连接的质量和效率。



### Len

在go/src/net中的addrselect.go文件中，Len是一个函数，其作用是返回传入的AddrList结构体中元素的数量。

具体而言，Len函数的定义如下：

```
func (list *AddrList) Len() int {
    return len(list.addrs)
}
```

在这个定义中，AddrList是一个结构体类型，里面包含一个addrs成员，是一个[]net.Addr类型的切片。因此，Len函数通过调用Go语言内置的len函数获取AddrList中addrs切片的长度，并返回这个长度值。

在AddrList类型的对象中，addrs存储了一些网络地址，例如IP地址或者主机名。而Len函数的作用就是方便地获取这些地址的数量，以便后续使用。在网络编程中，经常需要对不同的地址进行选择或者过滤，因此有时需要知道其中存储的地址数量。这时，可以利用Len函数实现这个功能。

需要注意的是，Len函数是一个方法，其与AddrList类型绑定，只能通过AddrList类型的对象进行调用。例如，如果list是一个AddrList类型的变量，可以通过list.Len()来获取其中存储的地址数量。



### Swap

Go语言中的`net`包提供了一个`AddrSelector`类型以及关联的一些函数，用于帮助程序在多个`IP`地址中选择最优的地址。`Swap`函数是`AddrSelector`类型中的一个方法，用于交换两个地址的位置。

具体来说，`Swap`方法接收两个索引`i`和`j`作为输入参数，并将`IP`地址切片中的第`i`个和第`j`个元素进行互换。在选择最优地址时，程序会根据地址的优先级推荐前面的地址，因此交换操作可以改变选择的结果，从而选择更优的地址。

以下是`Swap`方法的函数签名和部分源码：

```go
func (s *AddrSelector) Swap(i, j int) {
    s.addrs[i], s.addrs[j] = s.addrs[j], s.addrs[i]
}

type AddrSelector struct {
    addrs []*Addr
    // ...
}
```

在交换元素时，`Swap`方法使用了`Go`语言中的特色语法，即使用右侧的表达式作为值直接赋值给左侧的表达式。通过调用`Swap`方法实现元素的交换，可以方便地在多个`IP`地址中选择最优地址。



### Less

在go/src/net中的addrselect.go文件中，Less函数的作用是比较两个IP地址的优先级，它被用于IP地址优先级的排序以及计算可达性矩阵。

该函数的参数是两个IP地址，返回值是一个bool类型的值。当第一个IP地址的优先级高于第二个IP地址时，返回true，否则返回false。

该函数主要是通过比较两个IP地址的“优选级别”来决定它们之间的优先级。优选级别是一个int类型的值，表示IP地址的优先级，值越小优先级越高。 Less函数会首先比较IP地址的优选级别，若相同则比较子网掩码的长短，如果子网掩码长度也相同，则比较IP地址的值。

Less函数主要是应用于网络通信中的IP地址的选择，可以帮助选择网络连接最佳的IP地址，提高网络通信的效率。



### Classify

addrselect.go文件中的Classify函数的作用是在给定一组IP地址时对它们进行分类（分类为"primary"、"secondary"或"residue"）。

这个函数在选择网络地址时很有用。当多个IP地址可供选择时，通常会首选主要地址（primary），然后是次要地址（secondary），最后是剩余的地址（residue）。Classify函数能够将这些IP地址分类，并且返回一个排序过的地址列表。

该函数的实现是基于地址类型（IPv4或IPv6）和特定于网络的规则。对于IPv4地址，可以将其中一个类别的地址定义为使用网络的特殊地址。例如，这可能是广播或网络地址。对于IPv6地址，将由x:x:x:x:x:x:x:x这种格式表示的IPv6未指定地址视为residue。

具体实现方式是在IP地址的前缀中查找特殊的预定义地址并将它们分类为"primary"或"secondary"。在处理IPv6地址时，使用"residue"分类。在处理完这些特殊的地址后，根据IP地址的顺序将剩余的IP地址分类为"primary"或"secondary"。

最终，该函数返回排序过的IP地址列表，其中主要地址（primary）排在次要地址（secondary）之前。



### classifyScope

classifyScope函数的主要作用是将一个IP地址分配到其所属的地址范围中，例如，IPv4地址的地址范围可以是loopback、私有、保留或公共地址。分类地址范围通常用于网络路由和Internet Protocol（IP）地址分配。

在classifyScope函数中，根据IP地址的类型和具体的地址值，算法会判断该IP地址所属的地址范围，并将分类结果返回。如果IP地址位于某个特定的地址范围，则会指定其优先级，优先级的高低表明该地址的可访问程度。

classifyScope函数的实现依赖于多个私有函数及其它库文件，它使用了对于IPv4、IPv6地址范围的定义以及对于地址类型的标识等信息来确定IP地址的分类结果。分类结果将被用于网络路由的选择和IP地址分配的处理过程中。



### commonPrefixLen

commonPrefixLen的作用是计算传入的两个网络地址的公共前缀长度，即它们从最高位开始，第一个不同的位及其之前的一段位数。

该函数主要用于网格路由算法中，根据网络地址的公共前缀长度进行路由选择。网格路由算法是一种基于分层的路由寻址方案，通过将网络地址分层，然后根据每一层的网络地址的公共前缀长度来选择合适的路由器，从而实现快速路由转发。

该函数的实现比较简单，首先获取两个网络地址中长度较短的那个地址的长度，然后从高位到低位比较两个网络地址的每一位，直到遇到不同的位为止。最后返回这个不同位之前的相同位数。



