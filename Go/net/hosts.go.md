# File: hosts.go

hosts.go是Go语言标准库net包中的一个文件，主要用于处理从操作系统中获取的本地主机名和IP地址的信息。

该文件定义了一个结构体Hosts，其中包含了一个映射表，用于存储本地主机和IP地址之间的关系，以及一个锁，用于保证并发安全。

Hosts结构体中定义了几个重要的方法，包括：

- LookupIP：根据主机名查找对应的IP地址。该方法会先在映射表中查找，如果找不到则调用系统函数获取本地主机名和IP地址的信息，并更新映射表。
- addrsForName：为指定的主机名获取所有的IP地址。该方法会通过系统函数获取所有的IP地址，然后过滤掉非法的和重复的地址。
- readHostsFile：从系统hosts文件中解析出本地主机和IP地址之间的映射关系，并更新映射表。该方法会在Hosts结构体初始化时调用一次。

总之，hosts.go的作用是为net包提供了一个统一的接口，用于管理本地主机和IP地址之间的关系，提供了方便、高效、并发安全的方法来查找IP地址。




---

### Var:

### hosts

在Go语言的net包中，hosts变量是一个map类型，它的作用是存储IP地址和主机名的对应关系。具体来说，hosts这个变量将主机名映射为一个字符串数组，该数组中包含了主机可能拥有的所有IP地址，它可以用于帮助解析网络地址。在使用网络连接的时候，可以通过hosts变量来查找一个主机名对应的IP地址。

hosts变量所存储的IP地址和主机名的对应关系可以通过系统配置文件/etc/hosts、DNS服务器、NIS等方式来更新和修改。例如，在Linux系统中，可以通过修改/etc/hosts文件来添加或删除主机名和IP地址的对应关系。在程序运行过程中，可以通过调用net.LookupIP和net.LookupHost等函数来访问hosts变量中存储的主机名和IP地址信息，这些函数会自动使用系统配置文件和其他方式来获取主机名和IP地址的对应关系。

总之，hosts变量在Go语言的net包中扮演着重要的角色，它为程序提供了方便的网络地址解析功能，并且可以通过各种方式来更新和修改其中存储的信息。






---

### Structs:

### byName

hosts.go文件中有一个byName结构体，是用于对主机名进行排序并查找的。

该结构体实现了sort.Interface接口，包含了三个函数：Len、Less和Swap。通过这三个函数实现了按主机名排序。同时，byName结构体也实现了LookupHost函数， 可以通过主机名查找对应的IP地址。

在使用net包的函数中，如果需要根据主机名对IP地址进行排序或查找，就可以使用byName结构体。通过传递一个主机名的字符串，便可以获取对应的IP地址，并进行排序。这样可以方便地处理网络编程中的各种问题，提高程序的性能和效率。



## Functions:

### parseLiteralIP

在Go语言中，parseLiteralIP是net包中的一个函数，用于将一个IP地址文本串解析为一个net.IP类型的值。

该函数的作用是将IPv4地址转换为IPv6格式并返回一个net.IP类型的值。如果输入的是一个IPv4格式的地址(例如："192.168.0.1")，parseLiteralIP将把该地址转换为IPv6格式(例如：":ffff:192.168.0.1")。如果输入的是IPv6格式的地址(例如："2001:0db8:0000:0000:0000:ff00:0042:8329")，则该函数将直接返回该地址的net.IP类型的值。

该函数的输入参数是一个字符串（ip地址），输出是一个net.IP类型的值。如果输入的字符串不是一个合法的IP地址，则该函数将返回nil。如果字符串是一个有效的IP地址，但是不是IPv4或IPv6格式的，则该函数将返回一个net.IP类型的值，该值内部存储的是原始字节流表示的IP地址。

该函数的具体实现方式可以查看net包中的源码文件hosts.go。在该文件中，parseLiteralIP函数用正则表达式来检测IP地址是否合法，并根据输入的字符串是IPv4还是IPv6地址来进行不同的转换。



### readHosts

readHosts的作用是从本地文件系统中读取hosts文件内容，并解析出其中的IP地址和域名信息。

具体来说，它会首先读取/etc/hosts文件，然后将其中的每一行按空格分割，解析出其中的IP地址和域名。如果是IPv6地址，则需要将中括号去掉。如果该行以#开头，则表示该行是注释，会被忽略。

解析完所有行后，readHosts会将结果存储在一个map中，其中key为域名，value为一个包含该域名所有对应IP地址的slice。

在go中，可以通过调用net.LookupIP方法来查询一个域名的所有IP地址，它会首先查询本地hosts文件中是否有对应的记录，如果有，则直接返回这些IP地址；否则会向DNS服务器发起查询请求。

因此，修改hosts文件可以方便地实现一些网络调试和测试，比如在本地测试一个网站的不同IP地址对访问速度的影响等。



### lookupStaticHost

lookupStaticHost函数用于查询静态主机列表中是否存在指定的主机名，如果存在，则返回主机名对应的IP地址列表。

这个函数接收一个主机名作为参数，并返回一个IP地址列表。具体实现如下：

1. 首先，从全局变量staticHosts中查找是否存在指定的主机名。

2. 如果找到，则将该主机名对应的IP地址列表复制到一个临时变量中，并返回该临时变量。

3. 如果找不到，则返回一个空的IP地址列表。

可以看出，lookupStaticHost函数主要是用于实现从静态主机列表中查询IP地址的功能，这个功能通常用于实现一些基本的网络连接，如ping、http请求等。该函数只查询静态主机列表，不会进行DNS查询，因此查询速度较快，但可能会出现数据不准确的情况。



### lookupStaticAddr

func lookupStaticAddr(host string) (addrs []string, err error)

这个函数的作用是查询静态主机地址列表。它会从预定义的主机名和IP地址的映射表中查找与给定主机名对应的IP地址列表，如果找到了则返回这个IP地址列表，否则返回一个错误。

这个函数通常被用于在本地解析主机名时，例如在没有网络连接的情况下或者需要使用本地host文件进行域名解析时。此函数将在许多网络库中使用。

该函数内部实现使用了一个全局的映射表，这个表被初始化为一个“常规”主机名和IP地址的集合。这个表可以通过修改net包中的hosts.go代码进行自定义。这个表的检索是非常快速的，通常只需要O(1)时间，因为它可以直接在内存中查找IP地址。



