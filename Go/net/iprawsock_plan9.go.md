# File: iprawsock_plan9.go

iprawsock_plan9.go是Go语言标准库中net包中的一部分，它主要用于在Plan 9操作系统上操作IP原始套接字。

IP原始套接字提供了直接访问IP层的功能，它可以用于创建自定义协议或数据包分析工具。这个文件实现了在Plan 9系统上使用IP原始套接字作为通信方式的功能。

具体来说，此文件中定义了一个类型为ipv4RawConn的结构体，它实现了net包中的Conn接口，可以用于发送和接收IPv4原始数据报。除此之外，它还定义了一些常量、变量和函数，用于操作Plan 9系统上的IP原始套接字，如：

- IPRAW_HDRINCL：一个常量，用于控制发送IP数据报的头文件是否包含IP头。
- ipRawSock：一个全局变量，表示Plan 9系统上IP原始套接字的文件描述符。
- newIPv4RawConn：一个函数，用于创建ipv4RawConn类型的对象。

总之，iprawsock_plan9.go的作用是实现在Plan 9系统上使用IP原始套接字进行网络通信的功能，为开发者提供了更为灵活的网络编程方式。

## Functions:

### readFrom

readFrom函数是iprawsock_plan9.go文件中的一个函数，它的作用是从IP原始套接字中读取数据。具体来说，它通过调用系统调用_recvfrom从套接字中读取数据，并将读取的数据写入指定的缓冲区中。

readFrom函数的输入参数包括一个长度为MTU的字节数组buf，它用于存储从套接字中读取的数据；还有一个指向sockaddr结构的指针addr，它用于存储发送数据的来源地址；以及一个指向int类型的指针n，它用于记录读取的数据长度。

readFrom的输出参数是一个error类型，它指示了读取操作是否成功。如果读取操作成功，则返回值为nil；否则，返回值为一个非nil的error对象，指示读取操作失败的原因。例如，在读取数据时如果发生了网络错误或超时，readFrom将返回一个相应的错误对象。

总的来说，readFrom函数是IP原始套接字和其他网络层之间通信的重要组成部分，它负责从IP原始套接字中读取数据并将其传递到其他网络层进行处理。



### readMsg

在go/src/net中的iprawsock_plan9.go中，readMsg是一个函数，它的作用是从已经打开的IP数据报套接字中读取数据。

具体来说，readMsg函数中会使用net包中的io包来读取数据报，并将其存储在msg中。然后，它会从msg中提取出IP头，并将其存储在hdr中。最后，它会将msg中的数据报部分存储在p中，并返回一个net.Addr类型的源地址和一个error类型的错误信息。

该函数的主要作用是实现了从IP数据报套接字中读取数据报的功能，它可以让用户在实现IP层的网络协议时，从套接字中读取数据报，进而进行后续的处理。



### writeTo

iprawsock_plan9.go文件中的writeTo()函数用于将UDP或IP数据包写入基础原始套接字，可以将数据包从计算机发送到网络中的目标地址。

该函数的输入参数包括：

- b []byte：要发送的数据包的内容

- addr *IPAddr：目标IP地址以及端口号

- i CM :本次数据包的上下文

writeTo()函数的实现主要做了以下几件事情：

1. 获取当前系统的原始套接字对象和目标IP地址，把它们封装成一个socket对象。

2. 创建一个udpip结构体，用于设置IP头和UDP头。

3. 将传入的数据加入udpip结构体的Payload字段。

4. 使用socket对象的WriteTo()方法，将封装好的UDP/IP数据包通过原始套接字发送到目标IP地址。

总的来说，writeTo()函数的作用就是封装网络数据包并通过底层的原始套接字发送到目标地址。



### writeMsg

iprawsock_plan9.go文件中的writeMsg函数是用于向IP层发送数据包的函数。在IPv4和IPv6协议中，应用程序需要将数据交给IP层，由IP层负责进行路由选择，确定目的地址，并最终将数据包传递给相应的网络接口驱动程序发送出去。writeMsg函数就是这个过程中的一环。

在writeMsg函数中，首先会通过IPConn对象获取底层文件描述符（fd），然后将待发送的数据包封装成一个msghdr结构体。接着调用Plan9的writeMsg系统调用进行发送，最后将实际发送的字节数返回给调用者。

需要注意的是，在调用writeMsg函数之前，需要先使用IPConn对象中的SetMulticastTTL和SetMulticastLoop方法设置相应的多播TTL和多播环回选项。将多播TTL设置为大于0的值，可以控制多播数据包在网络中的传输范围；将多播环回选项开启，则可以将多播数据包回送到本地回环接口。

总的来说，writeMsg函数实现了应用程序向IP层发送数据包的功能，是网络编程中比较基础的一部分。



### dialIP

dialIP是一个函数，用于创建一个原始IP流套接字并连接到指定的IP目标地址。

该函数首先通过调用net.DialIP并传入指定的本地地址和目标地址来尝试与目标地址建立连接。如果成功连接，则返回连接套接字。如果无法连接，则通过调用ipv4rawsocket函数和ipv6rawsocket函数（如果IPv6可用）来创建标志为IPv4或IPv6的原始套接字。然后，将套接字绑定到指定的本地地址，并将其连接到目标地址。

这个函数主要是用于在Plan9系统中创建一个原始IP流套接字并连接到指定的IP目标地址，提供与网络通信的基础功能。



### listenIP

listenIP函数的作用是侦听指定IP地址和端口的网络连接。

在该函数中，首先根据指定的网络类型和地址创建一个原始的IP套接字，然后将该套接字绑定到指定的IP地址和端口。接下来，该函数启动一个在新套接字上侦听连接请求的goroutine，一旦有新的连接请求，它会将新连接的本地和远程地址分别保存在Conn结构中，并将该Conn结构传递给handleRead函数进行处理。

在handleRead函数中，它将检查新连接的协议类型，如果是IPv4协议，则会创建一个IPConn结构，并将该连接的本地和远程地址赋值给该结构。如果是IPv6协议，则会创建一个IPv6Conn结构，并将连接的本地和远程地址赋值给该结构。然后，它会将该Conn结构和创建的IPConn或IPv6Conn结构传递给go关键字创建的新的goroutine进行处理。

该函数的作用是在指定的IP地址和端口上侦听网络连接，并将新连接的信息保存在Conn结构中。



